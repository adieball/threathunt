filter {
    if [winlog][event_id] == 22 {
        mutate {
            add_tag => [ "DNS_log" ]
            add_field => { "[QueryName]" => "%{[winlog][event_data][QueryName]}" }
        }
        tld {
          source => "QueryName"
        }
        # Rename fields from the tld filter plugin
        mutate {
          rename => { "[tld][domain]" => "DNS_highest_registered_domain" }
          rename => { "[tld][subdomain]" => "DNS_tld_sub" }
          rename => { "[tld][trd]" => "DNS_subdomain" }
          rename => { "[tld][tld]" => "DNS_top_level_domain" }
          rename => { "[tld][sld]" => "DNS_parent_domain" }
        }
        rest {
          request => {
            url => "http://freqserver:10004/measure1/%{DNS_tld_sub}"
          }
          sprintf => true
          json => false
          target => "DNS_FullQuery_FREQ"
        }
        rest {
          request => {
            url => "http://freqserver:10004/measure1/%{DNS_subdomain}"
          }
          sprintf => true
          json => false
          target => "DNS_SubQuery_FREQ"
        }
        rest {
          request => {
            url => "http://freqserver:10004/measure1/%{DNS_parent_domain}"
          }
          sprintf => true
          json => false
          target => "DNS_ParentQuery_FREQ"
        }
        mutate {
          convert => [ "DNS_ParentQuery_FREQ", "float" ]
        }
        # If parent domain has a low frequency score, tag it with "DGA"
        if [DNS_ParentQuery_FREQ] != "0" and [DNS_ParentQuery_FREQ] < 4.0 {
          mutate {
            add_tag => [ "DGA" ]
          }
        }
        rest {
          request => {
            url => "http://domainstats:20000/alexa/%{QueryName}"
          }
          sprintf => true
          json => false
          target => "domain_score"
        }
        mutate {
          convert => [ "domain_score", "float" ]
        }
        # If domain score value exists, tag it with "top1-m"
        if [domain_score] >= 1.0 {
          mutate {
            add_tag => [ "top-1m" ]
          }
        }
        rest {
          request => {
            url => "http://domainstats:20000/domain/creation_date/%{QueryName}"
          }
          sprintf => true
          json => false
          target => "domain_creationdate"
        }
        mutate {
          remove_field => [ "QueryName" ]
        }
    }
}